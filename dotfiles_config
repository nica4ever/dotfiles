#!/bin/bash
# Link dotfiles to home directory

# Locate dotfiles dir
DOTDIR=$(find "$HOME" -maxdepth 3 -type d -name "dotfiles" -print -quit)

if [[ -z "$DOTDIR" ]]; then
    echo "ERROR: dotfiles directory not found"
    exit 1
fi

# All dirs needed â€” single loop instead of repeated mkdir
dirs=(
    ~/.config/rofi/shared
    ~/.config/sway/config.d
    ~/.config/waybar/modules
    ~/.config/gtk-3.0
    ~/.config/gtk-4.0
    ~/.config/alacritty/themes
    ~/.config/tmux/plugins/tmux-dotbar
    ~/.vim/autoload
    ~/.config/dunst
)

for d in "${dirs[@]}"; do
    mkdir -p "$d"
done

# Symlink map: source -> target
# One array, easy to read, easy to add new links
links=(
    ".bashrc|.bashrc"
    ".vimrc|.vimrc"
    ".vim/autoload/plug.vim|.vim/autoload/plug.vim"
    ".tmux.conf|.tmux.conf"
    ".config/tmux/plugins/tmux-dotbar/dotbar.tmux|.config/tmux/plugins/tmux-dotbar/dotbar.tmux"
    ".config/gtk-3.0/settings.ini|.config/gtk-3.0/settings.ini"
    ".config/gtk-4.0/settings.ini|.config/gtk-4.0/settings.ini"
    ".config/dunst/dunstrc|.config/dunst/dunstrc"
    ".config/sway/config|.config/sway/config"
    ".config/sway/config.d/20-swayidle.conf|.config/sway/config.d/20-swayidle.conf"
    ".config/sway/config.d/90-bar.conf|.config/sway/config.d/90-bar.conf"
    ".config/waybar/config|.config/waybar/config"
    ".config/waybar/launch.sh|.config/waybar/launch.sh"
    ".config/waybar/modules/powermenu.sh|.config/waybar/modules/powermenu.sh"
    ".config/waybar/style.css|.config/waybar/style.css"
    ".config/rofi/config.rasi|.config/rofi/config.rasi"
    ".config/rofi/tokyonight.rasi|.config/rofi/tokyonight.rasi"
    ".config/alacritty/alacritty.toml|.config/alacritty/alacritty.toml"
)

failed=0
for entry in "${links[@]}"; do
    src="${DOTDIR}/${entry%%|*}"
    dst="$HOME/${entry##*|}"
    if [[ -e "$src" ]]; then
        ln -sf "$src" "$dst"
    else
        echo "MISSING: $src"
        ((failed++))
    fi
done

echo "Dotfiles linked! ($failed missing)"
